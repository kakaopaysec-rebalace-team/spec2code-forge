# Rocky Linux Database AI System Dockerfile
# API í‚¤ ë¶ˆí•„ìš”í•œ ì™„ì „ ìë¦½í˜• í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì‹œìŠ¤í…œ

FROM rockylinux/rockylinux:9

LABEL maintainer="Database AI Team"
LABEL version="1.0.0"
LABEL description="API í‚¤ ë¶ˆí•„ìš”í•œ ìë¦½í˜• Database AI í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„ ì‹œìŠ¤í…œ"

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
ENV PYTHONUNBUFFERED=1
ENV PYTHONDONTWRITEBYTECODE=1
ENV NODE_OPTIONS="--max-old-space-size=2048"
ENV PORT=8003
ENV FRONTEND_PORT=8080

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# Rocky Linux íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ ë„êµ¬ ì„¤ì¹˜
RUN dnf update -y && \
    dnf install -y --allowerasing \
        python3 \
        python3-pip \
        python3-devel \
        sqlite \
        sqlite-devel \
        gcc \
        gcc-c++ \
        make \
        curl \
        wget \
        tar \
        git \
        procps-ng \
        lsof \
        net-tools && \
    dnf clean all

# Node.js 18 ì„¤ì¹˜ (Rocky Linux ê³µì‹ ì €ì¥ì†Œ)
RUN dnf module install -y nodejs:18/common && \
    npm install -g npm@latest

# ì‹œìŠ¤í…œ ê²€ì¦
RUN python3 --version && \
    node --version && \
    npm --version && \
    sqlite3 --version

# í”„ë¡œì íŠ¸ íŒŒì¼ ë³µì‚¬
COPY package.json package-lock.json ./
COPY backend/requirements.txt ./backend/
COPY . .

# ê¶Œí•œ ì„¤ì •
RUN chmod +x *.sh && \
    chmod 755 /app

# Python ê°€ìƒí™˜ê²½ ìƒì„± ë° ì˜ì¡´ì„± ì„¤ì¹˜
RUN cd backend && \
    python3 -m venv venv && \
    source venv/bin/activate && \
    pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt && \
    # Database AI Engine í•„ìˆ˜ íŒ¨í‚¤ì§€
    pip install --no-cache-dir aiosqlite pandas numpy scikit-learn

# Node.js ì˜ì¡´ì„± ì„¤ì¹˜ ë° í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ
RUN npm ci --only=production && \
    npm run build && \
    # ë¹Œë“œ ìºì‹œ ì •ë¦¬
    npm cache clean --force

# Rocky Linux íŠ¹í™” ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
RUN cd backend && \
    source venv/bin/activate && \
    python3 init_rocky_db.py && \
    chmod 664 *.db

# í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8003 8080

# í—¬ìŠ¤ì²´í¬ ì„¤ì •
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:8003/health || exit 1

# ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
RUN echo '#!/bin/bash' > /app/docker-start.sh && \
    echo 'set -e' >> /app/docker-start.sh && \
    echo 'echo "ğŸ§ Rocky Linux Dockerì—ì„œ Database AI ì‹œìŠ¤í…œ ì‹œì‘ ì¤‘..."' >> /app/docker-start.sh && \
    echo 'echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# ë°±ì—”ë“œ ì„œë²„ ì‹œì‘' >> /app/docker-start.sh && \
    echo 'echo "ğŸ ë°±ì—”ë“œ ì„œë²„ ì‹œì‘ ì¤‘ (í¬íŠ¸ 8003)..."' >> /app/docker-start.sh && \
    echo 'cd /app/backend' >> /app/docker-start.sh && \
    echo 'source venv/bin/activate' >> /app/docker-start.sh && \
    echo 'python start_backend.py &' >> /app/docker-start.sh && \
    echo 'BACKEND_PID=$!' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì‹œì‘' >> /app/docker-start.sh && \
    echo 'echo "âš›ï¸ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„ ì‹œì‘ ì¤‘ (í¬íŠ¸ 8080)..."' >> /app/docker-start.sh && \
    echo 'cd /app' >> /app/docker-start.sh && \
    echo 'npm run preview -- --host 0.0.0.0 --port 8080 &' >> /app/docker-start.sh && \
    echo 'FRONTEND_PID=$!' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# ì„œë²„ ì‹œì‘ ëŒ€ê¸°' >> /app/docker-start.sh && \
    echo 'sleep 10' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# ìƒíƒœ í™•ì¸' >> /app/docker-start.sh && \
    echo 'echo "ğŸ” ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸ ì¤‘..."' >> /app/docker-start.sh && \
    echo 'if curl -s http://localhost:8003/health >/dev/null; then' >> /app/docker-start.sh && \
    echo '    echo "âœ… ë°±ì—”ë“œ ì„œë²„: ì •ìƒ ì‘ë™"' >> /app/docker-start.sh && \
    echo 'else' >> /app/docker-start.sh && \
    echo '    echo "âŒ ë°±ì—”ë“œ ì„œë²„: ì˜¤ë¥˜"' >> /app/docker-start.sh && \
    echo 'fi' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo 'if curl -s http://localhost:8080 >/dev/null; then' >> /app/docker-start.sh && \
    echo '    echo "âœ… í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„: ì •ìƒ ì‘ë™"' >> /app/docker-start.sh && \
    echo 'else' >> /app/docker-start.sh && \
    echo '    echo "âŒ í”„ë¡ íŠ¸ì—”ë“œ ì„œë²„: ì˜¤ë¥˜"' >> /app/docker-start.sh && \
    echo 'fi' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# Database AI í…ŒìŠ¤íŠ¸' >> /app/docker-start.sh && \
    echo 'echo "ğŸ§  Database AI í…ŒìŠ¤íŠ¸ ì¤‘..."' >> /app/docker-start.sh && \
    echo 'if curl -s -X POST "http://localhost:8003/database-ai/generate-strategy" -H "Content-Type: application/json" -d '"'"'{"user_profile":{"risk_tolerance":"moderate","investment_goal":"wealth_building"}}'"'"' >/dev/null; then' >> /app/docker-start.sh && \
    echo '    echo "âœ… Database AI: ì •ìƒ ì‘ë™"' >> /app/docker-start.sh && \
    echo 'else' >> /app/docker-start.sh && \
    echo '    echo "âŒ Database AI: ì˜¤ë¥˜"' >> /app/docker-start.sh && \
    echo 'fi' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo 'echo ""' >> /app/docker-start.sh && \
    echo 'echo "ğŸ‰ Rocky Linux Docker ë°°í¬ ì™„ë£Œ!"' >> /app/docker-start.sh && \
    echo 'echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"' >> /app/docker-start.sh && \
    echo 'echo "ğŸ“± ì ‘ì† ì •ë³´:"' >> /app/docker-start.sh && \
    echo 'echo "   â€¢ ì›¹ì•±: http://localhost:8080"' >> /app/docker-start.sh && \
    echo 'echo "   â€¢ Database AI: http://localhost:8003/database-ai/generate-strategy"' >> /app/docker-start.sh && \
    echo 'echo "   â€¢ API ë¬¸ì„œ: http://localhost:8003/docs"' >> /app/docker-start.sh && \
    echo 'echo ""' >> /app/docker-start.sh && \
    echo 'echo "âœ¨ íŠ¹ì§•: API í‚¤ ë¶ˆí•„ìš”, 318ê°œ ì „ë¬¸ê°€ ì „ëµ, 67-71% ì‹ ë¢°ë„"' >> /app/docker-start.sh && \
    echo '' >> /app/docker-start.sh && \
    echo '# í”„ë¡œì„¸ìŠ¤ ëŒ€ê¸° (ì»¨í…Œì´ë„ˆ ìœ ì§€)' >> /app/docker-start.sh && \
    echo 'wait $BACKEND_PID $FRONTEND_PID' >> /app/docker-start.sh && \
    chmod +x /app/docker-start.sh

# ì»¨í…Œì´ë„ˆ ì‹œì‘ ëª…ë ¹
CMD ["/app/docker-start.sh"]